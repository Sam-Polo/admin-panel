# Панель управления SportYugra

## Структура проекта

```
admin-panel/
├── index.html          # главная страница с таблицами и модальными окнами
├── admin1.js          # основной js файл с логикой панели управления
├── auth.js            # логика авторизации
├── firebase-config.js # конфигурация Firebase
├── styles.css         # стили
├── add-object.html    # страница добавления нового объекта
├── add-object.js      # логика добавления объекта
├── set-custom-claims.js  # скрипт для установки ролей
├── firestore.rules    # правила безопасности Firestore
└── serviceAccountKey.json  # ключ для админки Firebase
```

## Роли пользователей

### Админ
- Полный доступ ко всем объектам
- Управление пользователями
- Управление тегами
- Доступ к разделу "Пользователи"

### Модератор
- Доступ только к назначенным объектам
- Управление тегами назначенных объектов
- Нет доступа к управлению пользователями

## Структура данных Firestore

### Коллекция sportobjects
```javascript
{
  name: string,
  description: string,      // название объекта
  address: string,
  phone: string,
  location: geopoint,
  photo-urls: array[string],   // массив URL фотографий
  tags: array[reference],    // массив ссылок на теги
  // другие поля объекта
}
```

### Коллекция tags
```javascript
{
  name: string,           // название тега
  parent: reference,      // ссылка на родительский тег (опционально)
  childrenTags: array     // массив дочерних тегов (опционально)
}
```

### Коллекция users
```javascript
{
  email: string,     // email пользователя
  admin: boolean,    // является ли админом
  objectIds: string[] // массив ID доступных объектов (для модераторов)
}
```

### Коллекция tag_changes
```javascript
{
  tag_id: string,        // id тега
  object_id: string,     // id объекта
  old_value: boolean,    // старое значение (был ли тег)
  new_value: boolean,    // новое значение (стал ли тег)
  timestamp: timestamp,  // время изменения
  user_id: string       // id пользователя, сделавшего изменение
}
```

## Иерархия тегов

Теги в системе организованы в иерархическую структуру:
1. Теги загружаются из Firestore с сортировкой по имени (`orderBy("name")`)
2. Дерево тегов строится рекурсивно с глубинным обходом
3. На каждом уровне иерархии теги сортируются по имени
4. Порядок отображения тегов в админ-панели соответствует порядку в мобильном приложении

## Custom Claims

Для установки ролей используются Custom Claims:

### Админ
```javascript
{
  admin: true
}
```

### Модератор
```javascript
{
  moderator: true,
  objectIds: ['id1', 'id2'] // массив ID доступных объектов
}
```

## Интерфейс

### Таблица объектов
- Отображение списка объектов
- Для админа - все объекты
- Для модератора - только назначенные объекты
- Кнопки действий: редактирование, управление тегами, удаление
- Кнопка "Добавить объект" (только для админа)

### Добавление объекта
- Доступно только администраторам
- Обязательные поля: название, адрес, координаты
- Дополнительные поля: описание, телефон
- Автоматическая генерация ID документа в Firestore
- Валидация полей на стороне клиента
- Подтверждение успешного добавления
- Возврат на главную страницу после добавления

### Управление тегами
- Древовидное отображение тегов с чекбоксами
- Сортировка тегов по имени на всех уровнях иерархии
- Отображение выбранных тегов для добавления/удаления
- Сохранение изменений с подтверждением
- История изменений тегов объекта
  - Отображение всех изменений тегов для текущего объекта
  - Сортировка по времени (новые сверху)
  - Отображение пользователя, сделавшего изменение
  - Отображение типа изменения (добавление/удаление тега)
  - Цветовая индикация статуса (зеленый для добавления, красный для удаления)
  - Отображение email пользователя вместо ID
- Автоматическое обновление данных на странице после сохранения
- Три режима работы:
  - Просмотр тегов (только просмотр текущих тегов)
  - Добавление тегов (управление тегами с возможностью добавления/удаления)
  - История изменений (просмотр истории изменений тегов)

### Таблица пользователей (только для админа)
- Отображение списка пользователей
- Управление ролями (админ/модератор)
- Назначение объектов модераторам
- Удаление пользователей

### Управление фотографиями
- Загрузка фотографий через модальное окно
- Поддержка drag & drop для загрузки
- Отображение прогресса загрузки
- Предпросмотр фотографий перед загрузкой
- Возможность выбора нескольких фотографий
- Удаление выбранных фотографий
- Просмотр фотографий в полном размере
- Навигация между фотографиями в режиме просмотра
- Хранение фотографий на ImgBB
- Сохранение прямых ссылок в Firestore
- Обработка ошибок загрузки и удаления
- Анимированные уведомления об успехе/ошибках

## Правила безопасности

- Админ имеет полный доступ ко всем объектам
- Модератор имеет доступ только к назначенным объектам
- Теги доступны для чтения всем авторизованным пользователям
- Управление тегами доступно только админу

## Разработка

1. Установка зависимостей:
npm install
```

2. Настройка Firebase:
- Создать проект в Firebase Console
- Включить Authentication и Firestore
- Скачать serviceAccountKey.json и положить в корень проекта

3. Создание первого администратора:
```bash
node set-custom-claims.js
```
Скрипт создаст пользователя с email `admin@admin.ru` и случайным паролем, который будет выведен в консоль. Этот пользователь получит права администратора.

4. Запуск:
```bash
firebase serve
```

## Деплой

```bash
firebase deploy
```

## Последние изменения

### Управление фотографиями
- Добавлен интерфейс для загрузки и управления фотографиями объектов
- Фотографии хранятся на сервисе ImgBB
- Прямые ссылки на фото сохраняются в Firestore в поле `photo-urls`
- Добавлена возможность просмотра фотографий в режиме галереи
- Реализована поддержка drag & drop для загрузки
- Добавлены анимированные уведомления об успехе/ошибках

### Интерфейс
- Добавлен футер с контактной информацией разработчика
- Улучшено отображение кнопок в таблице объектов
- Добавлена обратная связь при операциях с объектами и пользователями

### Безопасность
- Обновлен скрипт создания администратора
- Скрипт теперь автоматически создает учетную запись администратора
- Добавлена генерация безопасного пароля

## Контактная информация
Разработчик: semyon68p@gmail.com 